name: Flutter Tests & Coverage

# This tells GitHub when to run the tests
on:
  push:
    branches: [ main, master ]  # Runs when you push to main/master
  pull_request:
    branches: [ main, master ]  # Runs on pull requests

jobs:
  test:
    runs-on: ubuntu-latest  # Uses Ubuntu Linux to run tests
    
    steps:
    # Step 1: Download your code
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Step 2: Install Flutter
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    # Step 3: Install your app's dependencies
    - name: Install dependencies
      run: flutter pub get
      
    # Step 4: Check Flutter is working
    - name: Verify Flutter installation
      run: flutter doctor -v
      
    # Step 5: Check code for errors
    - name: Analyze code
      run: flutter analyze
      
    # Step 6: Run all tests with coverage
    - name: Run tests with coverage
      run: |
        flutter test test/pages_tests/ --coverage
        flutter test test/widget_tests/footer_tests.dart
      
    # Step 7: Check if coverage is above 50%
    - name: Check coverage percentage
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov
        COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
        echo "Coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 50" | bc -l) )); then
          echo "❌ Coverage is below 50%"
          exit 1
        else
          echo "✅ Coverage is $COVERAGE% (above 50%)"
        fi